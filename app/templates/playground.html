
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üéÆ HODLXXI Playground - Test All Auth Methods</title>

    <!-- React 18 -->

<script>
// GUEST_LABEL_PRETTY_PK_V1: show guest_label for current (PIN) guest in presence UI + anywhere else truncation is used
function prettyPk(pk) {
  try {
    const ds = (document && document.body && document.body.dataset) ? document.body.dataset : {};
    const myPk = ds.loggedIn || ds.loggedInPubkey || "";
    const myLabel = ds.guestLabel || "";
    if (myLabel && myPk && pk === myPk) return myLabel;
  } catch (e) {}

  if (!pk) return "";
  // default truncation
  if (pk.length <= 22) return pk;
  return prettyPk(pk);
}
</script>

<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- QR Code -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

    <!-- Socket.IO (if you want real-time later; safe to keep) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.1/socket.io.min.js"></script>

    <style>
        :root {
            --bg: #0b0f10;
            --panel: #11171a;
            --fg: #e6f1ef;
            --accent: #00ff88;
            --orange: #f7931a;
            --red: #ff3b30;
            --blue: #3b82f6;
            --muted: #8a9da4;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background: var(--bg);
            color: var(--fg);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
        }

        #matrix-bg {
            position: fixed;
            inset: 0;
            z-index: 0;
            pointer-events: none;
        }

        @media (prefers-reduced-motion: reduce) {
            #matrix-bg { display: none !important; }
        }

        /* root container (pushed down below sticky CTA bar) */
        #root {
            position: relative;
            z-index: 1;
            padding: 4.5rem 2rem 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: rgba(17, 23, 26, 0.92);
            border: 1px solid #0f2a24;
            border-radius: 14px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.08);
        }

        .header h1 {
            color: var(--accent);
            font-size: 2rem;
            margin-bottom: 0.5rem;
            text-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
        }

        .header-info {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .card {
            background: rgba(17, 23, 26, 0.92);
            border: 1px solid #0f2a24;
            border-radius: 14px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.08);
        }

        .card h2 {
            color: var(--accent);
            margin-bottom: 1rem;
            font-size: 1.3rem;
        }

        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .tab {
            background: #0e1516;
            border: 1px solid #184438;
            color: var(--fg);
            padding: 0.75rem 1.25rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .tab.active {
            background: var(--accent);
            color: #000;
            border-color: var(--accent);
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.3);
        }

        .tab:hover:not(.active) {
            border-color: var(--accent);
            background: rgba(0, 255, 136, 0.1);
        }

        input, textarea, select {
            width: 100%;
            background: #0e1315;
            color: var(--fg);
            border: 1px solid #255244;
            padding: 0.75rem;
            border-radius: 8px;
            font-family: ui-monospace, monospace;
            margin: 0.5rem 0;
            font-size: 0.9rem;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(0, 255, 136, 0.2);
        }

        button {
            background: var(--accent);
            color: #000;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 0.95rem;
        }

        button:hover {
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
            transform: translateY(-2px);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        button.secondary {
            background: transparent;
            border: 1px solid var(--accent);
            color: var(--accent);
        }

        button.danger {
            background: var(--red);
            color: white;
        }

        .result {
            background: #0e1315;
            border: 1px solid #255244;
            padding: 1rem;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.8rem;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 1rem;
        }

        .result.success {
            border-color: var(--accent);
            background: rgba(0, 255, 136, 0.05);
        }

        .result.error {
            border-color: var(--red);
            background: rgba(255, 59, 48, 0.05);
            color: var(--red);
        }

        .qr-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 1rem 0;
            padding: 1rem;
            background: white;
            border-radius: 12px;
            border: 2px solid var(--accent);
        }

        .qr-container canvas {
            display: block;
        }

        .status-badge {
            display: inline-block;
            padding: 0.35rem 0.85rem;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .status-badge.success {
            background: rgba(0, 255, 136, 0.2);
            color: var(--accent);
            border: 1px solid var(--accent);
        }

        .status-badge.pending {
            background: rgba(247, 147, 26, 0.2);
            color: var(--orange);
            border: 1px solid var(--orange);
        }

        .status-badge.error {
            background: rgba(255, 59, 48, 0.2);
            color: var(--red);
            border: 1px solid var(--red);
        }

        .label {
            font-size: 0.875rem;
            color: var(--accent);
            font-weight: 600;
            display: block;
            margin-top: 1rem;
            margin-bottom: 0.25rem;
        }

        .code-box {
            background: #0e1315;
            padding: 1rem;
            border-radius: 8px;
            border: 1px dashed var(--accent);
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .code-box:hover {
            background: rgba(0, 255, 136, 0.05);
            border-color: var(--accent);
        }

        .code-box code {
            color: var(--accent);
            word-break: break-all;
            font-size: 0.85rem;
        }

        .hint {
            background: rgba(247, 147, 26, 0.1);
            border-left: 3px solid var(--orange);
            padding: 1rem;
            border-radius: 6px;
            margin-top: 1rem;
        }

        .hint-title {
            color: var(--orange);
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .hint ol, .hint ul {
            margin-left: 1.5rem;
            color: var(--muted);
            font-size: 0.875rem;
        }

        .hint li {
            margin: 0.25rem 0;
        }

        .spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid rgba(0, 255, 136, 0.3);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            #root {
                padding: 3.5rem 1rem 1.5rem;
            }

            .header h1 {
                font-size: 1.5rem;
            }

            .tabs {
                flex-direction: column;
            }

            .tab {
                width: 100%;
                text-align: center;
            }
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-content {
            text-align: center;
        }

        /* --- Top CTA bar ------------------------------------------------- */
        .top-cta {
            position: sticky;
            top: 0;
            z-index: 12;
            width: 100%;
            display: flex;
            justify-content: center;
            padding: 0.45rem 0.75rem;
            background: radial-gradient(circle at top,
                        rgba(34, 197, 94, 0.16) 0,
                        rgba(3, 7, 18, 0.96) 45%,
                        rgba(3, 7, 18, 0.98) 100%);
            border-bottom: 1px solid rgba(0, 255, 136, 0.3);
            box-shadow: 0 18px 35px rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(16px);
        }

        .top-cta-inner {
            width: 100%;
            max-width: 1400px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.75rem;
        }

        .top-cta-text {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 0.4rem;
            font-size: 0.85rem;
            color: #cbd5f5;
        }

        .top-cta-text strong {
            color: var(--accent);
            font-weight: 600;
        }

        .top-cta-pill {
            padding: 0.18rem 0.6rem;
            border-radius: 999px;
            border: 1px solid rgba(0, 255, 136, 0.6);
            background: rgba(6, 95, 70, 0.7);
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #bbf7d0;
        }

        .top-cta-action {
            white-space: nowrap;
        }

        @media (max-width: 768px) {
            .top-cta-inner {
                flex-direction: column;
                align-items: flex-start;
            }

            .top-cta-action {
                width: 100%;
                text-align: center;
            }
        }
    </style>
</head>

<body>
    <canvas id="matrix-bg" aria-hidden="true"></canvas>


<!-- Login / Dashboard CTA Bar (outside React root) -->
<div class="top-cta">
    <div class="top-cta-text">
        {% if session.logged_in_pubkey %}
            <span class="top-cta-pill">‚úÖ Logged in</span>
            <span class="mono">{{ session.get("guest_label") or (session.logged_in_pubkey[:18] ~ "‚Ä¶") }}</span>

        {% else %}
            <span class="top-cta-pill">üéÆ Playground</span>
            <strong>Test Bitcoin identity, then upgrade when you&#39;re ready.</strong>

            <button class="top-cta-btn"
                    onclick="window.location.href='/login?next=/upgrade'">
                Sign in / Create account
            </button>
        {% endif %}
    </div>
</div>


    <div id="root"
         data-logged-in="{{ session.get('logged_in_pubkey', '') }}" data-guest-label="{{ session.get('guest_label', '') }}"
         data-access-level="{{ session.get('access_level', 'guest') }}"
         data-issuer="{{ issuer }}"
         data-initial-tab="{{ initial_tab or 'legacy' }}">
    </div>

    <!-- Matrix Animation -->
    <script>
        (function() {
            const canvas = document.getElementById('matrix-bg');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const CHARS = ['0','1'];
            let width = 0, height = 0, particles = [], raf = null;

            function resize() {
                const dpr = Math.max(1, Math.min(window.devicePixelRatio || 1, 2));
                const cssW = window.innerWidth, cssH = window.innerHeight;
                canvas.width = Math.floor(cssW * dpr);
                canvas.height = Math.floor(cssH * dpr);
                canvas.style.width = cssW + 'px';
                canvas.style.height = cssH + 'px';
                ctx.setTransform(1,0,0,1,0,0);
                ctx.scale(dpr, dpr);
                width = cssW; height = cssH;
                particles = [];
                for (let i = 0; i < 400; i++) {
                    particles.push({
                        x: (Math.random() - 0.5) * width,
                        y: (Math.random() - 0.5) * height,
                        z: Math.random() * 800 + 100
                    });
                }
                ctx.fillStyle = 'rgba(0,0,0,1)';
                ctx.fillRect(0, 0, width, height);
            }

            function draw() {
                ctx.fillStyle = 'rgba(0,0,0,0.25)';
                ctx.fillRect(0, 0, width, height);
                ctx.fillStyle = '#00ff88';
                for (const p of particles) {
                    const scale = 200 / p.z;
                    const x2 = width / 2 + p.x * scale;
                    const y2 = height / 2 + p.y * scale;
                    const size = Math.max(8 * scale, 1);
                    ctx.font = size + 'px monospace';
                    ctx.fillText(CHARS[(Math.random() > 0.5) | 0], x2, y2);
                    p.z -= 5;
                    if (p.z < 1) {
                        p.x = (Math.random() - 0.5) * width;
                        p.y = (Math.random() - 0.5) * height;
                        p.z = 800;
                    }
                }
                raf = requestAnimationFrame(draw);
            }

            function onVis() {
                if (document.hidden) {
                    if (raf) cancelAnimationFrame(raf), raf = null;
                } else {
                    if (!raf) raf = requestAnimationFrame(draw);
                }
            }

            window.addEventListener('resize', resize);
            document.addEventListener('visibilitychange', onVis);
            resize();
            raf = requestAnimationFrame(draw);
        })();
    </script>

    <!-- React App -->
    <script type="text/babel">
    {% raw %}
    const { useState, useEffect, useRef } = React;

    function PlaygroundApp() {
        const rootEl = document.getElementById('root') || {};
        const ds = rootEl.dataset || {};

        const initialTab  = ds.initialTab  || 'legacy';
        const loggedIn    = ds.loggedIn    || '';
        const accessLevel = ds.accessLevel || 'guest';
        const issuer      = ds.issuer      || '';

        const [activeTab, setActiveTab] = useState(initialTab);
        const [result, setResult] = useState(null);
        const [loading, setLoading] = useState(false);
        const [pofPubkey, setPofPubkey] = useState('');
        const [challengeId, setChallengeId] = useState('');
        const [challengeText, setChallengeText] = useState('');
        const [psbt, setPsbt] = useState('');
        const [privacyLevel, setPrivacyLevel] = useState('aggregate');
        const [minSat, setMinSat] = useState('0');
        const [pofStep, setPofStep] = useState(1);
        return (
            <div>
                <div className="header">
                    <h1>üéÆ HODLXXI API Playground</h1>
                    <p style={{color: 'var(--muted)', marginBottom: '1rem'}}>
                        Test all authentication methods, OAuth flows, and Bitcoin verification in real-time
                    </p>
                    {loggedIn && loggedIn !== "" ? (
                        <div className="header-info">
                            <span className="status-badge success">
                                Logged in: {loggedIn.slice(-8)}
                            </span>
                            <span className="status-badge pending">
                                Access: {accessLevel}
                            </span>
                        </div>
                    ) : (
                        <div className="header-info">
                            <span className="status-badge error">
                                Not logged in
                            </span>
                        </div>
                    )}
                </div>

                {loading && (
                    <div className="loading-overlay">
                        <div className="loading-content">
                            <div className="loading-spinner"></div>
                            <p style={{color: 'var(--accent)'}}>Processing...</p>
                        </div>
                    </div>
                )}

                <div className="card">
                    <div className="tabs">
                        <button
                            className={`tab ${activeTab === 'legacy' ? 'active' : ''}`}
                            onClick={() => setActiveTab('legacy')}
                        >
                            üîê Legacy Signature
                        </button>
                        <button
                            className={`tab ${activeTab === 'api' ? 'active' : ''}`}
                            onClick={() => setActiveTab('api')}
                        >
                            ‚ö° API Challenge
                        </button>
                        <button
                            className={`tab ${activeTab === 'lnurl' ? 'active' : ''}`}
                            onClick={() => setActiveTab('lnurl')}
                        >
                            ‚ö° LNURL-Auth
                        </button>
                        <button
                            className={`tab ${activeTab === 'oauth' ? 'active' : ''}`}
                            onClick={() => setActiveTab('oauth')}
                        >
                            üîë OAuth Flow
                        </button>
                        <button
                            className={`tab ${activeTab === 'pof' ? 'active' : ''}`}
                            onClick={() => setActiveTab('pof')}
                        >
                            üí∞ Proof of Funds
                        </button>
                    </div>

                    {activeTab === 'legacy' && <LegacyTab setResult={setResult} setLoading={setLoading} />}
                    {activeTab === 'api' && <APITab setResult={setResult} setLoading={setLoading} />}
                    {activeTab === 'lnurl' && <LNURLTab setResult={setResult} setLoading={setLoading} issuer={issuer} />}
                    {activeTab === 'oauth' && <OAuthTab setResult={setResult} setLoading={setLoading} issuer={issuer} />}
                    {activeTab === 'pof' && <PoFTab setResult={setResult} setLoading={setLoading} />}
                </div>

                {result && (
                    <div className="card">
                        <h2>üìä Result</h2>
                        <div className={`result ${result.error ? 'error' : 'success'}`}>
                            <pre>{JSON.stringify(result, null, 2)}</pre>
                        </div>
                        <button
                            className="secondary"
                            style={{marginTop: '1rem'}}
                            onClick={() => setResult(null)}
                        >
                            Clear Result
                        </button>
                    </div>
                )}
            </div>
        );
    }

    function LegacyTab({ setResult, setLoading }) {
        const [pubkey, setPubkey] = useState('');
        const [signature, setSignature] = useState('');
        const [challenge, setChallenge] = useState('Loading...');

        useEffect(() => {
            fetch('/login')
                .then(r => r.text())
                .then(html => {
                    const match = html.match(/id="legacyChallenge"[^>]*>([^<]+)</);
                    if (match) setChallenge(match[1].trim());
                    else setChallenge('Failed to load challenge');
                })
                .catch(() => setChallenge('Error loading challenge'));
        }, []);

        const handleVerify = async () => {
            if (!pubkey || !signature) {
                setResult({ error: 'Both pubkey and signature are required' });
                return;
            }

            setLoading(true);
            try {
                const res = await fetch('/verify_signature', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pubkey, signature, challenge })
                });
                const data = await res.json();
                setResult(data);

                if (data.verified) {
                    setTimeout(() => window.location.href = '/app', 2000);
                }
            } catch (err) {
                setResult({ error: err.message });
            } finally {
                setLoading(false);
            }
        };

        const copyChallenge = () => {
            navigator.clipboard.writeText(challenge);
            alert('Challenge copied to clipboard!');
        };

        return (
            <div>
                <label className="label">Challenge (Sign this in your wallet)</label>
                <div className="code-box" onClick={copyChallenge} title="Click to copy">
                    <code>{challenge}</code>
                </div>

                <label className="label">Public Key</label>
                <input
                    value={pubkey}
                    onChange={(e) => setPubkey(e.target.value)}
                    placeholder="02... or 03... (66 hex chars)"
                />

                <label className="label">Signature (Base64)</label>
                <textarea
                    value={signature}
                    onChange={(e) => setSignature(e.target.value)}
                    placeholder="Base64 signature from Electrum/Sparrow/Bitcoin Core"
                    rows="4"
                />

                <button onClick={handleVerify} style={{marginTop: '1rem'}}>
                    Verify &amp; Login
                </button>

                <div className="hint">
                    <div className="hint-title">How to sign:</div>
                    <ol>
                        <li>Copy the challenge above</li>
                        <li>Open your Bitcoin wallet (Electrum, Sparrow, etc.)</li>
                        <li>Find "Sign Message" feature</li>
                        <li>Paste challenge, sign with your key</li>
                        <li>Copy signature and paste above</li>
                    </ol>
                </div>
            </div>
        );
    }

    function APITab({ setResult, setLoading }) {
        const [pubkey, setPubkey] = useState('');
        const [challengeId, setChallengeId] = useState('');
        const [challengeText, setChallengeText] = useState('');
        const [signature, setSignature] = useState('');
        const [step, setStep] = useState(1);

        const getChallenge = async () => {
            if (!pubkey) {
                setResult({ error: 'Public key is required' });
                return;
            }

            setLoading(true);
            try {
                const res = await fetch('/api/challenge', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ pubkey })
                });
                const data = await res.json();

                if (data.challenge_id && data.challenge) {
                    setChallengeId(data.challenge_id);
                    setChallengeText(data.challenge);
                    setStep(2);
                    setResult(data);
                } else {
                    setResult({ error: 'Invalid response from server' });
                }
            } catch (err) {
                setResult({ error: err.message });
            } finally {
                setLoading(false);
            }
        };

        const verify = async () => {
            if (!signature) {
                setResult({ error: 'Signature is required' });
                return;
            }

            setLoading(true);
            try {
                const res = await fetch('/api/verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        pubkey,
                        signature,
                        challenge_id: challengeId
                    })
                });
                const data = await res.json();
                setResult(data);

                if (data.verified) {
                    setTimeout(() => window.location.href = '/app', 2000);
                }
            } catch (err) {
                setResult({ error: err.message });
            } finally {
                setLoading(false);
            }
        };

        return (
            <div>
                <div style={{marginBottom: '1rem'}}>
                    <span className="status-badge success">Step {step} of 2</span>
                </div>

                <label className="label">Public Key</label>
                <input
                    value={pubkey}
                    onChange={(e) => setPubkey(e.target.value)}
                    placeholder="02... or npub..."
                    disabled={step === 2}
                />

                {step === 1 && (
                    <button onClick={getChallenge} style={{marginTop: '0.5rem'}}>
                        Get Challenge
                    </button>
                )}

                {step === 2 && (
                    <>
                        <label className="label">Challenge (Click to copy)</label>
                        <div className="code-box" onClick={() => copyText(challengeText)}>
                            <code>{challengeText}</code>
                        </div>

                        <label className="label">Challenge ID</label>
                        <input value={challengeId} readOnly />

                        <label className="label">Signature (Base64)</label>
                        <textarea
                            value={signature}
                            onChange={(e) => setSignature(e.target.value)}
                            placeholder="Paste signature here"
                            rows="4"
                        />

                        <div style={{display: 'flex', gap: '0.5rem', marginTop: '1rem'}}>
                            <button onClick={verify}>Verify &amp; Login</button>
                            <button className="secondary" onClick={() => { setStep(1); setChallengeText(''); setSignature(''); }}>
                                Start Over
                            </button>
                        </div>
                    </>
                )}

                <div className="hint">
                    <div className="hint-title">API Authentication Flow:</div>
                    <ol>
                        <li>Request challenge with your pubkey</li>
                        <li>Sign challenge with your Bitcoin wallet</li>
                        <li>Submit signature for verification</li>
                        <li>Receive access token on success</li>
                    </ol>
                </div>
            </div>
        );
    }

    function LNURLTab({ setResult, setLoading, issuer }) {
        const [lnurl, setLnurl] = useState('');
        const [sessionId, setSessionId] = useState('');
        const [polling, setPolling] = useState(false);
        const qrRef = useRef(null);
        const pollIntervalRef = useRef(null);

        useEffect(() => {
            return () => {
                if (pollIntervalRef.current) {
                    clearInterval(pollIntervalRef.current);
                }
            };
        }, []);

        const createSession = async () => {
            setLoading(true);
            try {
                const res = await fetch('/api/lnurl-auth/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                });
                const data = await res.json();

                if (data.lnurl && data.session_id) {
                    setLnurl(data.lnurl);
                    setSessionId(data.session_id);
                    setResult(data);

                    if (qrRef.current && window.QRCode) {
                        qrRef.current.innerHTML = '';
                        new QRCode(qrRef.current, {
                            text: data.lnurl,
                            width: 256,
                            height: 256,
                            colorDark: '#000000',
                            colorLight: '#ffffff'
                        });
                    }

                    setPolling(true);
                    pollIntervalRef.current = setInterval(async () => {
                        try {
                            const checkRes = await fetch(`/api/lnurl-auth/check/${data.session_id}`);
                            const checkData = await checkRes.json();

                            if (checkData.authenticated) {
                                clearInterval(pollIntervalRef.current);
                                setPolling(false);
                                setResult({
                                    ...checkData,
                                    message: '‚úì Authentication successful!',
                                    success: true
                                });
                                setTimeout(() => window.location.href = '/app', 2000);
                            }
                        } catch (err) {
                            console.error('Polling error:', err);
                        }
                    }, 2000);
                } else {
                    setResult({ error: 'Invalid response from server' });
                }
            } catch (err) {
                setResult({ error: err.message });
            } finally {
                setLoading(false);
            }
        };

        const stopPolling = () => {
            if (pollIntervalRef.current) {
                clearInterval(pollIntervalRef.current);
                setPolling(false);
            }
        };

        return (
            <div>
                {!lnurl ? (
                    <button onClick={createSession}>
                        Create LNURL-Auth Session
                    </button>
                ) : (
                    <>
                        <div className="qr-container">
                            <div ref={qrRef}></div>
                        </div>

                        <label className="label">LNURL (Click to copy)</label>
                        <div
                            className="code-box"
                            onClick={() => {
                                navigator.clipboard.writeText(lnurl);
                                alert('LNURL copied to clipboard!');
                            }}
                            style={{fontSize: '0.75rem', wordBreak: 'break-all'}}
                        >
                            <code>{lnurl}</code>
                        </div>

                        <div style={{display: 'flex', gap: '0.5rem', marginTop: '1rem', flexWrap: 'wrap'}}>
                            <a
                                href={`lightning:${lnurl}`}
                                style={{
                                    display: 'inline-block',
                                    padding: '0.75rem 1.5rem',
                                    background: 'var(--orange)',
                                    color: '#fff',
                                    borderRadius: '8px',
                                    textDecoration: 'none',
                                    fontWeight: 600
                                }}
                            >
                                Open in Wallet
                            </a>
                            <button className="secondary" onClick={stopPolling}>
                                {polling ? 'Stop Polling' : 'Stopped'}
                            </button>
                        </div>

                        {polling && (
                            <div style={{marginTop: '1rem', textAlign: 'center'}}>
                                <span className="spinner" style={{marginRight: '0.5rem'}}></span>
                                <span style={{color: 'var(--muted)'}}>
                                    Waiting for authentication... (Session: {sessionId.slice(0, 8)}...)
                                </span>
                            </div>
                        )}
                    </>
                )}

                <div className="hint">
                    <div className="hint-title">Compatible Wallets:</div>
                    <ul>
                        <li>Alby (Browser extension)</li>
                        <li>Mutiny (Web/Mobile)</li>
                        <li>Zeus (Mobile)</li>
                        <li>Phoenix (Mobile)</li>
                        <li>Blixt (Mobile)</li>
                    </ul>
                </div>
            </div>
        );
    }

    function OAuthTab({ setResult, setLoading, issuer }) {
        const [clientId, setClientId] = useState('');
        const [clientSecret, setClientSecret] = useState('');
        const [registeredClient, setRegisteredClient] = useState(null);
        const [showSecret, setShowSecret] = useState(false);

        const registerClient = async () => {
            setLoading(true);
            try {
                const res = await fetch('/oauth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        redirect_uris: ['http://localhost:3000/callback', 'https://oauth.pstmn.io/v1/callback']
                    })
                });
                const data = await res.json();

                if (data.client_id && data.client_secret) {
                    setRegisteredClient(data);
                    setClientId(data.client_id);
                    setClientSecret(data.client_secret);
                    setResult(data);
                } else {
                    setResult({ error: 'Registration failed', details: data });
                }
            } catch (err) {
                setResult({ error: err.message });
            } finally {
                setLoading(false);
            }
        };

        const startOAuthFlow = () => {
            const params = new URLSearchParams({
                client_id: clientId,
                redirect_uri: 'http://localhost:3000/callback',
                scope: 'read',
                response_type: 'code',
                state: Math.random().toString(36).slice(2)
            });
            const url = `/oauth/authorize?${params}`;
            window.open(url, '_blank', 'width=600,height=800');
        };

        return (
            <div>
                {!registeredClient ? (
                    <>
                        <button onClick={registerClient}>
                            Register New OAuth Client
                        </button>

                        <div className="hint">
                            <div className="hint-title">What is OAuth2?</div>
                            <p style={{color: 'var(--muted)', fontSize: '0.875rem'}}>
                                OAuth 2.0 is an authorization framework that enables applications to obtain
                                limited access to user accounts. This playground lets you test the full
                                OAuth flow including client registration, authorization, and token exchange.
                            </p>
                        </div>
                    </>
                ) : (
                    <>
                        <label className="label">Client ID</label>
                        <div className="code-box" onClick={() => navigator.clipboard.writeText(clientId)}>
                            <code>{clientId}</code>
                        </div>

                        <label className="label">Client Secret (Save this securely!)</label>
                        <div style={{position: 'relative'}}>
                            <input
                                type={showSecret ? 'text' : 'password'}
                                value={clientSecret}
                                readOnly
                                style={{fontFamily: 'monospace'}}
                            />
                            <button
                                className="secondary"
                                style={{
                                    position: 'absolute',
                                    right: '0.5rem',
                                    top: '50%',
                                    transform: 'translateY(-50%)',
                                    padding: '0.5rem 1rem'
                                }}
                                onClick={() => setShowSecret(!showSecret)}
                            >
                                {showSecret ? 'üôà Hide' : 'üëÅÔ∏è Show'}
                            </button>
                        </div>

                        <div style={{marginTop: '1rem'}}>
                            <button onClick={startOAuthFlow}>
                                Start Authorization Flow
                            </button>
                        </div>

                        <div className="hint">
                            <div className="hint-title">Next Steps:</div>
                            <ol>
                                <li>Click "Start Authorization Flow"</li>
                                <li>Authorize in the popup window</li>
                                <li>You'll receive an authorization code</li>
                                <li>Exchange code for access token at <code>/oauth/token</code></li>
                            </ol>
                        </div>

                        <div className="hint" style={{marginTop: '1rem', borderColor: 'var(--accent)'}}>
                            <div className="hint-title" style={{color: 'var(--accent)'}}>Token Exchange Example:</div>
                            <pre style={{background: '#000', padding: '1rem', borderRadius: '6px', overflow: 'auto'}}>
{`curl -X POST ${issuer}/oauth/token \\
  -H "Content-Type: application/x-www-form-urlencoded" \\
  -d "grant_type=authorization_code" \\
  -d "client_id=${clientId}" \\
  -d "client_secret=${clientSecret}" \\
  -d "code=YOUR_AUTH_CODE" \\
  -d "redirect_uri=http://localhost:3000/callback"`}
                            </pre>
                        </div>
                    </>
                )}
            </div>
        );
    }

    function PoFTab({ setResult, setLoading }) {
        const [pofPubkey, setPofPubkey] = useState('');
        const [challengeId, setChallengeId] = useState('');
        const [challengeText, setChallengeText] = useState('');
        const [psbt, setPsbt] = useState('');
        const [privacyLevel, setPrivacyLevel] = useState('aggregate');
        const [minSat, setMinSat] = useState('0');
        const [pofStep, setPofStep] = useState(1);

        // 1) Get PoF challenge from backend
        const getPoFChallenge = async () => {
            if (!pofPubkey) {
                setResult({ error: 'Public key (or label) is required' });
                return;
            }

            setLoading(true);
            try {
                const res = await fetch('/api/challenge', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ pubkey: pofPubkey })
                });

                // Handle non-JSON / 5xx gracefully
                if (!res.ok) {
                    const raw = await res.text();
                    setResult({
                        error: 'Non-JSON response from /api/challenge',
                        status: res.status,
                        raw: raw.slice(0, 400)
                    });
                    return;
                }

                const data = await res.json();

                if (data.ok && data.challenge_id && data.challenge) {
                    setChallengeId(data.challenge_id);
                    setChallengeText(data.challenge);
                    setPofStep(2);
                    setResult({
                        ...data,
                        hint: 'Now build a PSBT that includes this string in an OP_RETURN'
                    });
                } else {
                    setResult({ error: data.error || 'Invalid response from challenge endpoint' });
                }
            } catch (err) {
                setResult({ error: err.message || String(err) });
            } finally {
                setLoading(false);
            }
        };

        // 2) Verify PSBT against challenge
        const verifyPoFPSBT = async () => {
            if (!challengeId) {
                setResult({ error: 'Challenge ID is missing ‚Äì create a challenge first.' });
                return;
            }
            if (!psbt) {
                setResult({ error: 'Paste a signed PSBT first.' });
                return;
            }

            setLoading(true);
            try {
                const psbtClean = (psbt || "").toString().trim().replace(/\s+/g, "");
                const looksLikePubkey = (v) => {
                    if (!v) return false;
                    const s = String(v).trim();
                    if (s.toLowerCase().startsWith('npub1')) return true;
                    return /^[0-9a-fA-F]{64}$/.test(s) || /^[0-9a-fA-F]{66}$/.test(s) || /^[0-9a-fA-F]{130}$/.test(s);
                };

                const res = await fetch('/api/pof/verify_psbt', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        challenge_id: challengeId,
                        // IMPORTANT:
                        // If user typed a label (like "3333"), send pubkey="" so backend uses session pubkey fallback.
                        pubkey: looksLikePubkey(pofPubkey) ? pofPubkey : '',
                        psbt: psbtClean,  // NOTE: backend /api/pof/verify_psbt expects "signature" (not PSBT)
                        privacy_level: privacyLevel || 'aggregate',
                        min_sat: Number(minSat) || 0
                    })
                });

                const text = await res.text();
                let data = null;

                try {
                    data = text ? JSON.parse(text) : null;
                } catch {
                    // Not JSON ‚Üí wrap raw
                    setResult({
                        error: `Non-JSON response from /api/pof/verify_psbt`,
                        status: res.status,
                        raw: text
                    });
                    return;
                }

                // If status is not 2xx, still show server JSON as-is
                if (!res.ok) {
                    setResult(data || {
                        error: `Server error from /api/pof/verify_psbt`,
                        status: res.status
                    });
                    return;
                }

                // Success
                setResult(data);
            } catch (err) {
                setResult({ error: err.message || String(err) });
            } finally {
                setLoading(false);
            }
        };

        return (
            <div className="tab-panel">
                <h2>üí∞ Proof of Funds (PSBT OP_RETURN demo)</h2>
                <p className="muted">
                    2-step flow: 1) get challenge, 2) sign a PSBT that includes it in OP_RETURN and spends your UTXOs.
                </p>

                {/* Step 1: Get challenge */}
                <div className="section">
                    <h3>Step 1 ¬∑ Get Challenge</h3>
                    <label className="field-label">Your pubkey / label</label>
                    <input
                        className="input"
                        placeholder="playground-demo or your pubkey"
                        value={pofPubkey}
                        onChange={(e) => setPofPubkey(e.target.value)}
                    />
                    <button className="primary" onClick={getPoFChallenge}>
                        üîê Generate Challenge
                    </button>

                    {challengeId && (
                        <div className="mt-2">
                            <label className="field-label">Challenge ID</label>
                            <input className="input" value={challengeId} readOnly />

                            <label className="field-label">Challenge String (put this in OP_RETURN)</label>
                            <div className="code-box" onClick={() => copyText(challengeText)}>
                                <code>{challengeText}</code>
                            </div>
                        </div>
                    )}
                </div>

                {/* Step 2: Paste signed PSBT */}
                <div className="section">
                    <h3>Step 2 ¬∑ Paste Signed PSBT</h3>

                    <label className="field-label">PSBT (base64)</label>
                    <textarea
                        className="textarea"
                        rows={6}
                        placeholder="Paste signed PSBT here"
                        value={psbt}
                        onChange={(e) => setPsbt(e.target.value)}
                    />

                    <div className="field-row">
                        <div>
                            <label className="field-label">Privacy level</label>
                            <select
                                className="input"
                                value={privacyLevel}
                                onChange={(e) => setPrivacyLevel(e.target.value)}
                            >
                                <option value="boolean">Boolean</option>
                                <option value="threshold">Threshold</option>
                                <option value="aggregate">Aggregate</option>
                                <option value="exact">Exact</option>
                            </select>
                        </div>
                        <div>
                            <label className="field-label">Min sats (optional)</label>
                            <input
                                className="input"
                                type="number"
                                value={minSat}
                                onChange={(e) => setMinSat(e.target.value)}
                            />
                        </div>
                    </div>

                    <button className="primary" onClick={verifyPoFPSBT}>
                        ‚úÖ Verify PSBT Proof
                    </button>

                    <button
                        className="secondary"
                        style={{ marginLeft: '0.5rem' }}
                        onClick={() => {
                            setPofStep(1);
                            setChallengeId('');
                            setChallengeText('');
                            setPsbt('');
                            setResult(null);
                        }}
                    >
                        üîÑ Reset PoF Demo
                    </button>
                </div>
            </div>
        );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<PlaygroundApp />);
    {% endraw %}
    </script>
</body>
</html>
