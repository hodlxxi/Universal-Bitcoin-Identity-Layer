{% raw %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéÆ HODLXXI Playground - Test All Auth Methods</title>
    
    <!-- React 18 -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- QR Code -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    
    <!-- Socket.IO -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.1/socket.io.min.js"></script>
    
    <style>
        :root {
            --bg: #0b0f10;
            --panel: #11171a;
            --fg: #e6f1ef;
            --accent: #00ff88;
            --orange: #f7931a;
            --red: #ff3b30;
            --blue: #3b82f6;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            background: var(--bg);
            color: var(--fg);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        #matrix-bg {
            position: fixed;
            inset: 0;
            z-index: 0;
            pointer-events: none;
        }
        
        @media (prefers-reduced-motion: reduce) {
            #matrix-bg { display: none !important; }
        }
        
        #root {
            position: relative;
            z-index: 1;
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: rgba(17, 23, 26, 0.92);
            border: 1px solid #0f2a24;
            border-radius: 14px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.08);
        }
        
        .header h1 {
            color: var(--accent);
            font-size: 2rem;
            margin-bottom: 0.5rem;
            text-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
        }
        
        .header-info {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }
        
        .card {
            background: rgba(17, 23, 26, 0.92);
            border: 1px solid #0f2a24;
            border-radius: 14px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.08);
        }
        
        .card h2 {
            color: var(--accent);
            margin-bottom: 1rem;
            font-size: 1.3rem;
        }
        
        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }
        
        .tab {
            background: #0e1516;
            border: 1px solid #184438;
            color: var(--fg);
            padding: 0.75rem 1.25rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            font-size: 0.9rem;
        }
        
        .tab.active {
            background: var(--accent);
            color: #000;
            border-color: var(--accent);
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.3);
        }
        
        .tab:hover:not(.active) {
            border-color: var(--accent);
            background: rgba(0, 255, 136, 0.1);
        }
        
        input, textarea, select {
            width: 100%;
            background: #0e1315;
            color: var(--fg);
            border: 1px solid #255244;
            padding: 0.75rem;
            border-radius: 8px;
            font-family: ui-monospace, monospace;
            margin: 0.5rem 0;
            font-size: 0.9rem;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(0, 255, 136, 0.2);
        }
        
        button {
            background: var(--accent);
            color: #000;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 0.95rem;
        }
        
        button:hover {
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
            transform: translateY(-2px);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        button.secondary {
            background: transparent;
            border: 1px solid var(--accent);
            color: var(--accent);
        }
        
        button.danger {
            background: var(--red);
            color: white;
        }
        
        .result {
            background: #0e1315;
            border: 1px solid #255244;
            padding: 1rem;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.8rem;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 1rem;
        }
        
        .result.success {
            border-color: var(--accent);
            background: rgba(0, 255, 136, 0.05);
        }
        
        .result.error {
            border-color: var(--red);
            background: rgba(255, 59, 48, 0.05);
            color: var(--red);
        }
        
        .qr-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 1rem 0;
            padding: 1rem;
            background: white;
            border-radius: 12px;
            border: 2px solid var(--accent);
        }
        
        .qr-container canvas {
            display: block;
        }
        
        .status-badge {
            display: inline-block;
            padding: 0.35rem 0.85rem;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .status-badge.success {
            background: rgba(0, 255, 136, 0.2);
            color: var(--accent);
            border: 1px solid var(--accent);
        }
        
        .status-badge.pending {
            background: rgba(247, 147, 26, 0.2);
            color: var(--orange);
            border: 1px solid var(--orange);
        }
        
        .status-badge.error {
            background: rgba(255, 59, 48, 0.2);
            color: var(--red);
            border: 1px solid var(--red);
        }
        
        .label {
            font-size: 0.875rem;
            color: var(--accent);
            font-weight: 600;
            display: block;
            margin-top: 1rem;
            margin-bottom: 0.25rem;
        }
        
        .code-box {
            background: #0e1315;
            padding: 1rem;
            border-radius: 8px;
            border: 1px dashed var(--accent);
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .code-box:hover {
            background: rgba(0, 255, 136, 0.05);
            border-color: var(--accent);
        }
        
        .code-box code {
            color: var(--accent);
            word-break: break-all;
            font-size: 0.85rem;
        }
        
        .hint {
            background: rgba(247, 147, 26, 0.1);
            border-left: 3px solid var(--orange);
            padding: 1rem;
            border-radius: 6px;
            margin-top: 1rem;
        }
        
        .hint-title {
            color: var(--orange);
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .hint ol, .hint ul {
            margin-left: 1.5rem;
            color: var(--muted);
            font-size: 0.875rem;
        }
        
        .hint li {
            margin: 0.25rem 0;
        }
        
        .spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid rgba(0, 255, 136, 0.3);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            #root {
                padding: 1rem;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                width: 100%;
                text-align: center;
            }
        }
        
        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .loading-content {
            text-align: center;
        }
        
        .loading-spinner {
            width: 3rem;
            height: 3rem;
            border: 3px solid rgba(0, 255, 136, 0.3);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 1rem;
        }
    </style>
</head>
<body>
    <canvas id="matrix-bg" aria-hidden="true"></canvas>
    <div id="root"></div>
    
    <!-- Matrix Animation -->
    <script>
        (function() {
            const canvas = document.getElementById('matrix-bg');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const CHARS = ['0','1'];
            let width = 0, height = 0, particles = [], raf = null;

            function resize() {
                const dpr = Math.max(1, Math.min(window.devicePixelRatio || 1, 2));
                const cssW = window.innerWidth, cssH = window.innerHeight;
                canvas.width = Math.floor(cssW * dpr);
                canvas.height = Math.floor(cssH * dpr);
                canvas.style.width = cssW + 'px';
                canvas.style.height = cssH + 'px';
                ctx.setTransform(1,0,0,1,0,0);
                ctx.scale(dpr, dpr);
                width = cssW; height = cssH;
                particles = [];
                for (let i = 0; i < 400; i++) {
                    particles.push({
                        x: (Math.random() - 0.5) * width,
                        y: (Math.random() - 0.5) * height,
                        z: Math.random() * 800 + 100
                    });
                }
                ctx.fillStyle = 'rgba(0,0,0,1)';
                ctx.fillRect(0, 0, width, height);
            }

            function draw() {
                ctx.fillStyle = 'rgba(0,0,0,0.25)';
                ctx.fillRect(0, 0, width, height);
                ctx.fillStyle = '#00ff88';
                for (const p of particles) {
                    const scale = 200 / p.z;
                    const x2 = width / 2 + p.x * scale;
                    const y2 = height / 2 + p.y * scale;
                    const size = Math.max(8 * scale, 1);
                    ctx.font = size + 'px monospace';
                    ctx.fillText(CHARS[(Math.random() > 0.5) | 0], x2, y2);
                    p.z -= 5;
                    if (p.z < 1) {
                        p.x = (Math.random() - 0.5) * width;
                        p.y = (Math.random() - 0.5) * height;
                        p.z = 800;
                    }
                }
                raf = requestAnimationFrame(draw);
            }

            function onVis() {
                if (document.hidden) { 
                    if (raf) cancelAnimationFrame(raf), raf = null; 
                } else { 
                    if (!raf) raf = requestAnimationFrame(draw); 
                }
            }

            window.addEventListener('resize', resize);
            document.addEventListener('visibilitychange', onVis);
            resize();
            raf = requestAnimationFrame(draw);
        })();
    </script>
    
    <!-- React App -->
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        function PlaygroundApp() {
            console.log("PlaygroundApp starting...");
            const [activeTab, setActiveTab] = useState('legacy');
            const [result, setResult] = useState(null);
            const [loading, setLoading] = useState(false);
            
            const loggedIn = "";
            const accessLevel = "limited";
            const issuer = "https://hodlxxi.com";
            
            return (
                <div>
                    <div className="header">
                        <h1>üéÆ HODLXXI API Playground</h1>
                        <p style="color: var(--muted); margin-bottom: 1rem">
                            Test all authentication methods, OAuth flows, and Bitcoin verification in real-time
                        </p>
                        {loggedIn && loggedIn !== '' ? (
                            <div className="header-info">
                                <span className="status-badge success">
                                    Logged in: {loggedIn.slice(-8)}
                                </span>
                                <span className="status-badge pending">
                                    Access: {accessLevel}
                                </span>
                            </div>
                        ) : (
                            <div className="header-info">
                                <span className="status-badge error">
                                    Not logged in
                                </span>
                            </div>
                        )}
                    </div>
                    
                    {loading && (
                        <div className="loading-overlay">
                            <div className="loading-content">
                                <div className="loading-spinner"></div>
                                <p style="color: var(--accent)">Processing...</p>
                            </div>
                        </div>
                    )}
                    
                    <div className="card">
                        <div className="tabs">
                            <button 
                                className={{`tab ${activeTab === 'legacy' ? 'active' : ''}`}
                                onClick={() => setActiveTab('legacy')}
                            >
                                üîê Legacy Signature
                            </button>
                            <button 
                                className={{`tab ${activeTab === 'api' ? 'active' : ''}`}
                                onClick={() => setActiveTab('api')}
                            >
                                ‚ö° API Challenge
                            </button>
                            <button 
                                className={{`tab ${activeTab === 'lnurl' ? 'active' : ''}`}
                                onClick={() => setActiveTab('lnurl')}
                            >
                                ‚ö° LNURL-Auth
                            </button>
                            <button 
                                className={{`tab ${activeTab === 'oauth' ? 'active' : ''}`}
                                onClick={() => setActiveTab('oauth')}
                            >
                                üîë OAuth Flow
                            </button>
                            <button 
                                className={{`tab ${activeTab === 'pof' ? 'active' : ''}`}
                                onClick={() => setActiveTab('pof')}
                            >
                                üí∞ Proof of Funds
                            </button>
                        </div>
                        
                        {activeTab === 'legacy' && <LegacyTab setResult={setResult} setLoading={setLoading} />}
                        {activeTab === 'api' && <APITab setResult={setResult} setLoading={setLoading} />}
                        {activeTab === 'lnurl' && <LNURLTab setResult={setResult} setLoading={setLoading} issuer={issuer} />}
                        {activeTab === 'oauth' && <OAuthTab setResult={setResult} setLoading={setLoading} issuer={issuer} />}
                        {activeTab === 'pof' && <PoFTab setResult={setResult} setLoading={setLoading} />}
                    </div>
                    
                    {result && (
                        <div className="card">
                            <h2>üìä Result</h2>
                            <div className={{`result ${result.error ? 'error' : 'success'}`}>
                                <pre>{JSON.stringify(result, null, 2)}</pre>
                            </div>
                            <button 
                                className="secondary" 
                                style="margin-top: 1rem"
                                onClick={() => setResult(null)}
                            >
                                Clear Result
                            </button>
                        </div>
                    )}
                </div>
            );
        }
        
        // === TAB COMPONENTS ===
        
        function LegacyTab({ setResult, setLoading }) {
            const [pubkey, setPubkey] = useState('');
            const [signature, setSignature] = useState('');
            const [challenge, setChallenge] = useState('Loading...');
            
            useEffect(() => {
                fetch('/login')
                    .then(r => r.text())
                    .then(html => {
                        const match = html.match(/id="legacyChallenge"[^>]*>([^<]+)</);
                        if (match) setChallenge(match[1].trim());
                        else setChallenge('Failed to load challenge');
                    })
                    .catch(() => setChallenge('Error loading challenge'));
            }, []);
            
            const handleVerify = async () => {
                if (!pubkey || !signature) {
                    setResult({ error: 'Both pubkey and signature are required' });
                    return;
                }
                
                setLoading(true);
                try {
                    const res = await fetch('/verify_signature', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ pubkey, signature, challenge })
                    });
                    const data = await res.json();
                    setResult(data);
                    
                    if (data.verified) {
                        setTimeout(() => window.location.href = '/app', 2000);
                    }
                } catch (err) {
                    setResult({ error: err.message });
                } finally {
                    setLoading(false);
                }
            };
            
            const copyChallenge = () => {
                navigator.clipboard.writeText(challenge);
                alert('Challenge copied to clipboard!');
            };
            
            return (
                <div>
                    <label className="label">Challenge (Sign this in your wallet)</label>
                    <div className="code-box" onClick={copyChallenge} title="Click to copy">
                        <code>{challenge}</code>
                    </div>
                    
                    <label className="label">Public Key</label>
                    <input 
                        value={pubkey}
                        onChange={(e) => setPubkey(e.target.value)}
                        placeholder="02... or 03... (66 hex chars)"
                    />
                    
                    <label className="label">Signature (Base64)</label>
                    <textarea 
                        value={signature}
                        onChange={(e) => setSignature(e.target.value)}
                        placeholder="Base64 signature from Electrum/Sparrow/Bitcoin Core"
                        rows="4"
                    />
                    
                    <button onClick={handleVerify} style="margin-top: 1rem">
                        Verify & Login
                    </button>
                    
                    <div className="hint">
                        <div className="hint-title">How to sign:</div>
                        <ol>
                            <li>Copy the challenge above</li>
                            <li>Open your Bitcoin wallet (Electrum, Sparrow, etc.)</li>
                            <li>Find "Sign Message" feature</li>
                            <li>Paste challenge, sign with your key</li>
                            <li>Copy signature and paste above</li>
                        </ol>
                    </div>
                </div>
            );
        }
        
        function APITab({ setResult, setLoading }) {
            const [pubkey, setPubkey] = useState('');
            const [challengeId, setChallengeId] = useState('');
            const [challengeText, setChallengeText] = useState('');
            const [signature, setSignature] = useState('');
            const [step, setStep] = useState(1);
            
            const getChallenge = async () => {
                if (!pubkey) {
                    setResult({ error: 'Public key is required' });
                    return;
                }
                
                setLoading(true);
                try {
                    const res = await fetch('/api/challenge', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ pubkey })
                    });
                    const data = await res.json();
                    
                    if (data.challenge_id && data.challenge) {
                        setChallengeId(data.challenge_id);
                        setChallengeText(data.challenge);
                        setStep(2);
                        setResult(data);
                    } else {
                        setResult({ error: 'Invalid response from server' });
                    }
                } catch (err) {
                    setResult({ error: err.message });
                } finally {
                    setLoading(false);
                }
            };
            
            const verify = async () => {
                if (!signature) {
                    setResult({ error: 'Signature is required' });
                    return;
                }
                
                setLoading(true);
                try {
                    const res = await fetch('/api/verify', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            pubkey, 
                            signature, 
                            challenge_id: challengeId 
                        })
                    });
                    const data = await res.json();
                    setResult(data);
                    
                    if (data.verified) {
                        setTimeout(() => window.location.href = '/app', 2000);
                    }
                } catch (err) {
                    setResult({ error: err.message });
                } finally {
                    setLoading(false);
                }
            };
            
            const copyText = (text) => {
                navigator.clipboard.writeText(text);
                alert('Copied to clipboard!');
            };
            
            return (
                <div>
                    <div style="margin-bottom: 1rem">
                        <span className="status-badge success">Step {step} of 2</span>
                    </div>
                    
                    <label className="label">Public Key</label>
                    <input 
                        value={pubkey}
                        onChange={(e) => setPubkey(e.target.value)}
                        placeholder="02... or npub..."
                        disabled={step === 2}
                    />
                    
                    {step === 1 && (
                        <button onClick={getChallenge} style="margin-top: 0.5rem">
                            Get Challenge
                        </button>
                    )}
                    
                    {step === 2 && (
                        <>
                            <label className="label">Challenge (Click to copy)</label>
                            <div className="code-box" onClick={() => copyText(challengeText)}>
                                <code>{challengeText}</code>
                            </div>
                            
                            <label className="label">Challenge ID</label>
                            <input value={challengeId} readOnly />
                            
                            <label className="label">Signature (Base64)</label>
                            <textarea 
                                value={signature}
                                onChange={(e) => setSignature(e.target.value)}
                                placeholder="Paste signature here"
                                rows="4"
                            />
                            
                            <div style="display: flex; gap: 0.5rem; margin-top: 1rem">
                                <button onClick={verify}>Verify & Login</button>
                                <button className="secondary" onClick={() => { setStep(1); setChallengeText(''); setSignature(''); }}>
                                    Start Over
                                </button>
                            </div>
                        </>
                    )}
                    
                    <div className="hint">
                        <div className="hint-title">API Authentication Flow:</div>
                        <ol>
                            <li>Request challenge with your pubkey</li>
                            <li>Sign challenge with your Bitcoin wallet</li>
                            <li>Submit signature for verification</li>
                            <li>Receive access token on success</li>
                        </ol>
                    </div>
                </div>
            );
        }
        
        function LNURLTab({ setResult, setLoading, issuer }) {
            const [lnurl, setLnurl] = useState('');
            const [sessionId, setSessionId] = useState('');
            const [polling, setPolling] = useState(false);
            const qrRef = useRef(null);
            const pollIntervalRef = useRef(null);
            
            useEffect(() => {
                return () => {
                    if (pollIntervalRef.current) {
                        clearInterval(pollIntervalRef.current);
                    }
                };
            }, []);
            
            const createSession = async () => {
                setLoading(true);
                try {
                    const res = await fetch('/api/lnurl-auth/create', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    const data = await res.json();
                    
                    if (data.lnurl && data.session_id) {
                        setLnurl(data.lnurl);
                        setSessionId(data.session_id);
                        setResult(data);
                        
                        // Generate QR
                        if (qrRef.current && window.QRCode) {
                            qrRef.current.innerHTML = '';
                            new QRCode(qrRef.current, {
                                text: data.lnurl,
                                width: 256,
                                height: 256,
                                colorDark: '#000000',
                                colorLight: '#ffffff'
                            });
                        }
                        
                        // Start polling
                        setPolling(true);
                        pollIntervalRef.current = setInterval(async () => {
                            try {
                                const checkRes = await fetch((`/api/lnurl-auth/check/${data.session_id}`);
                                const checkData = await checkRes.json();
                                
                                if (checkData.authenticated) {
                                    clearInterval(pollIntervalRef.current);
                                    setPolling(false);
                                    setResult({ 
                                        ...checkData, 
                                        message: '‚úì Authentication successful!',
                                        success: true
                                    });
                                    setTimeout(() => window.location.href = '/app', 2000);
                                }
                            } catch (err) {
                                console.error('Polling error:', err);
                            }
                        }, 2000);
                    } else {
                        setResult({ error: 'Invalid response from server' });
                    }
                } catch (err) {
                    setResult({ error: err.message });
                } finally {
                    setLoading(false);
                }
            };
            
            const stopPolling = () => {
                if (pollIntervalRef.current) {
                    clearInterval(pollIntervalRef.current);
                    setPolling(false);
                }
            };
            
            return (
                <div>
                    {!lnurl ? (
                        <button onClick={createSession}>
                            Create LNURL-Auth Session
                        </button>
                    ) : (
                        <>
                            <div className="qr-container">
                                <div ref={qrRef}></div>
                            </div>
                            
                            <label className="label">LNURL (Click to copy)</label>
                            <div 
                                className="code-box" 
                                onClick={() => {
                                    navigator.clipboard.writeText(lnurl);
                                    alert('LNURL copied to clipboard!');
                                }}
                                style="font-size: 0.75rem; word-break: break-all"
                            >
                                <code>{lnurl}</code>
                            </div>
                            
                            <div style="display: flex; gap: 0.5rem; margin-top: 1rem; flex-wrap: wrap">
                                <a 
                                    href={{`lightning:${lnurl}`} 
                                    style="display: inline-block; padding: 0.75rem 1.5rem; background: var(--orange); color: #fff; border-radius: 8px; text-decoration: none; font-weight: 600"
                                >
                                    Open in Wallet
                                </a>
                                <button className="secondary" onClick={stopPolling}>
                                    {polling ? 'Stop Polling' : 'Stopped'}
                                </button>
                            </div>
                            
                            {polling && (
                                <div style="margin-top: 1rem; text-align: center">
                                    <span className="spinner" style="margin-right: 0.5rem"></span>
                                    <span style="color: var(--muted)">
                                        Waiting for authentication... (Session: {sessionId.slice(0, 8)}...)
                                    </span>
                                </div>
                            )}
                        </>
                    )}
                    
                    <div className="hint">
                        <div className="hint-title">Compatible Wallets:</div>
                        <ul>
                            <li>Alby (Browser extension)</li>
                            <li>Mutiny (Web/Mobile)</li>
                            <li>Zeus (Mobile)</li>
                            <li>Phoenix (Mobile)</li>
                            <li>Blixt (Mobile)</li>
                        </ul>
                    </div>
                </div>
            );
        }
        
        function OAuthTab({ setResult, setLoading, issuer }) {
            const [clientId, setClientId] = useState('');
            const [clientSecret, setClientSecret] = useState('');
            const [registeredClient, setRegisteredClient] = useState(null);
            const [showSecret, setShowSecret] = useState(false);
            
            const registerClient = async () => {
                setLoading(true);
                try {
                    const res = await fetch('/oauth/register', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            redirect_uris: ['http://localhost:3000/callback', 'https://oauth.pstmn.io/v1/callback']
                        })
                    });
                    const data = await res.json();
                    
                    if (data.client_id && data.client_secret) {
                        setRegisteredClient(data);
                        setClientId(data.client_id);
                        setClientSecret(data.client_secret);
                        setResult(data);
                    } else {
                        setResult({ error: 'Registration failed', details: data });
                    }
                } catch (err) {
                    setResult({ error: err.message });
                } finally {
                    setLoading(false);
                }
            };
            
            const startOAuthFlow = () => {
                const params = new URLSearchParams({
                    client_id: clientId,
                    redirect_uri: 'http://localhost:3000/callback',
                    scope: 'read',
                    response_type: 'code',
                    state: Math.random().toString(36).slice(2)
                });
                const url = `/oauth/authorize?${params}`;
                window.open(url, '_blank', 'width=600,height=800');
            };
            
            return (
                <div>
                    {!registeredClient ? (
                        <>
                            <button onClick={registerClient}>
                                Register New OAuth Client
                            </button>
                            
                            <div className="hint">
                                <div className="hint-title">What is OAuth2?</div>
                                <p style="color: var(--muted); font-size: 0.875rem">
                                    OAuth 2.0 is an authorization framework that enables applications to obtain 
                                    limited access to user accounts. This playground lets you test the full 
                                    OAuth flow including client registration, authorization, and token exchange.
                                </p>
                            </div>
                        </>
                    ) : (
                        <>
                            <label className="label">Client ID</label>
                            <div className="code-box" onClick={() => navigator.clipboard.writeText(clientId)}>
                                <code>{clientId}</code>
                            </div>
                            
                            <label className="label">Client Secret (Save this securely!)</label>
                            <div style="position: relative">
                                <input 
                                    type={showSecret ? 'text' : 'password'}
                                    value={clientSecret}
                                    readOnly
                                    style="font-family: monospace"
                                />
                                <button 
                                    className="secondary"
                                    style="position: absolute; right: 0.5rem; top: 50%; transform: translateY(-50%); padding: 0.5rem 1rem"
                                    onClick={() => setShowSecret(!showSecret)}
                                >
                                    {showSecret ? 'üôà Hide' : 'üëÅÔ∏è Show'}
                                </button>
                            </div>
                            
                            <div style="margin-top: 1rem">
                                <button onClick={startOAuthFlow}>
                                    Start Authorization Flow
                                </button>
                            </div>
                            
                            <div className="hint">
                                <div className="hint-title">Next Steps:</div>
                                <ol>
                                    <li>Click "Start Authorization Flow"</li>
                                    <li>Authorize in the popup window</li>
                                    <li>You'll receive an authorization code</li>
                                    <li>Exchange code for access token at <code>/oauth/token</code></li>
                                </ol>
                            </div>
                            
                            <div className="hint" style="margin-top: 1rem">
                                <div className="hint-title">Token Exchange Example:</div>
                                <pre style="background: #000; padding: 1rem; border-radius: 6px; overflow: auto">
{`curl -X POST ${issuer}/oauth/token \\
  -H "Content-Type: application/x-www-form-urlencoded" \\
  -d "grant_type=authorization_code" \\
  -d "client_id=${clientId}" \\
  -d "client_secret=${clientSecret}" \\
  -d "code=YOUR_AUTH_CODE" \\
  -d "redirect_uri=http://localhost:3000/callback"`}
                                </pre>
                            </div>
                        </>
                    )}
                </div>
            );
        }
        
        function PoFTab({ setResult, setLoading }) {
            const [pubkey, setPubkey] = useState('');
            const [challengeId, setChallengeId] = useState('');
            const [challenge, setChallenge] = useState('');
            const [psbt, setPsbt] = useState('');
            const [step, setStep] = useState(1);
            
            const getChallenge = async () => {
                if (!pubkey) {
                    setResult({ error: 'Public key is required' });
                    return;
                }
                
                setLoading(true);
                try {
                    const res = await fetch('/api/pof/challenge', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ pubkey })
                    });
                    const data = await res.json();
                    
                    if (data.challenge_id && data.challenge) {
                        setChallengeId(data.challenge_id);
                        setChallenge(data.challenge);
                        setStep(2);
                        setResult(data);
                    } else {
                        setResult({ error: 'Failed to get challenge', details: data });
                    }
                } catch (err) {
                    setResult({ error: err.message });
                } finally {
                    setLoading(false);
                }
            };
            
            const verifyPSBT = async () => {
                if (!psbt) {
                    setResult({ error: 'PSBT is required' });
                    return;
                }
                
                setLoading(true);
                try {
                    const res = await fetch('/api/playground/pof/verify', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            challenge_id: challengeId,
                            psbt,
                            privacy_level: 'aggregate',
                            min_sat: 0
                        })
                    });
                    const data = await res.json();
                    setResult(data);
                } catch (err) {
                    setResult({ error: err.message });
                } finally {
                    setLoading(false);
                }
            };
            
            return (
                <div>
                    <div style="margin-bottom: 1rem">
                        <span className="status-badge success">Step {step} of 2</span>
                    </div>
                    
                    <label className="label">Public Key</label>
                    <input 
                        value={pubkey}
                        onChange={(e) => setPubkey(e.target.value)}
                        placeholder="02... or npub..."
                        disabled={step === 2}
                    />
                    
                    {step === 1 && (
                        <button onClick={getChallenge} style="margin-top: 0.5rem">
                            Get PoF Challenge
                        </button>
                    )}
                    
                    {step === 2 && (
                        <>
                            <label className="label">Challenge (Include in OP_RETURN)</label>
                            <div 
                                className="code-box" 
                                onClick={() => {
                                    navigator.clipboard.writeText(challenge);
                                    alert('Challenge copied!');
                                }}
                            >
                                <code>{challenge}</code>
                            </div>
                            
                            <label className="label">PSBT (Base64)</label>
                            <textarea 
                                value={psbt}
                                onChange={(e) => setPsbt(e.target.value)}
                                placeholder="Paste PSBT here (must contain OP_RETURN with challenge)"
                                rows="8"
                            />
                            
                            <div style="display: flex; gap: 0.5rem; margin-top: 1rem">
                                <button onClick={verifyPSBT}>Verify Proof</button>
                                <button className="secondary" onClick={() => { setStep(1); setChallenge(''); setPsbt(''); }}>
                                    Start Over
                                </button>
                            </div>
                        </>
                    )}
                    
                    <div className="hint">
                        <div className="hint-title">üîê How to create SIGNED PoF PSBT:</div>
                        <ol>
                            <li>Create a transaction with your UTXOs as inputs</li>
                            <li>Add an OP_RETURN output containing the challenge string</li>
                            <li><strong style="color: var(--orange)">‚≠ê SIGN the PSBT with your wallet</strong> (required for proof!)</li>
                            <li><strong>DO NOT broadcast the transaction</strong></li>
                            <li>Export signed PSBT as base64 format</li>
                            <li>Paste the PSBT above and verify</li>
                        </ol>
                        <div style="margin-top: 0.75rem; padding: 0.75rem; background: rgba(255, 59, 48, 0.1); border-radius: 6px; border-left: 3px solid var(--red);">
                            <strong style="color: var(--red)">‚ö†Ô∏è Important:</strong> Unsigned PSBTs will be rejected! 
                            You must use <code style="color: var(--red)">walletprocesspsbt</code> or similar to sign the PSBT before submitting.
                        </div>
                    </div>
                    
                    <div className="hint" style="margin-top: 1rem; border-color: var(--accent)">
                        <div className="hint-title" style="color: var(--accent)">Privacy Levels:</div>
                        <ul>
                            <li><strong>Boolean:</strong> Only yes/no (meets threshold?)</li>
                            <li><strong>Threshold:</strong> True/false for specific amount</li>
                            <li><strong>Aggregate:</strong> Exact total revealed (default)</li>
                        </ul>
                    </div>
                </div>
            );
        }

        // Render app
        console.log("About to render React...");
        ReactDOM.createRoot(document.getElementById('root')).render(<PlaygroundApp />);
    </script>
</body>
</html>


{% endraw %}
