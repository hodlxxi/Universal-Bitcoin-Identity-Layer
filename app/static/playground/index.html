<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HODLXXI Playground - Bitcoin Identity Layer</title>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Courier New', monospace; background: #000; color: #0f0; min-height: 100vh; overflow-x: hidden; }

        #matrix-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; opacity: 0.1; }
        .container { position: relative; z-index: 1; max-width: 1200px; margin: 0 auto; padding: 2rem; }

        .hero { text-align: center; padding: 3rem 0; }
        h1 {
            font-size: 3rem;
            background: linear-gradient(to right, #ff6b00, #ffd700, #ff6b00);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 1rem;
            animation: glow 2s ease-in-out infinite;
        }
        @keyframes glow { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }

        .tagline { color: #888; font-size: 1.2rem; margin-bottom: 2rem; }
        .stats { display: flex; justify-content: center; gap: 2rem; flex-wrap: wrap; margin-bottom: 3rem; }
        .stat { color: #0f0; font-size: 0.9rem; }
        .stat span { color: #fff; font-weight: bold; }

        .demos { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 2rem; margin: 3rem 0; }
        .demo-card { background: rgba(0, 255, 0, 0.05); border: 2px solid #0f0; border-radius: 8px; padding: 2rem; transition: all 0.3s ease; cursor: pointer; }
        .demo-card:hover { background: rgba(0, 255, 0, 0.1); border-color: #ff6b00; transform: translateY(-5px); box-shadow: 0 10px 30px rgba(255, 107, 0, 0.3); }
        .demo-icon { font-size: 3rem; margin-bottom: 1rem; }
        .demo-title { color: #ff6b00; font-size: 1.5rem; margin-bottom: 0.5rem; }
        .demo-desc { color: #888; font-size: 0.9rem; line-height: 1.5; margin-bottom: 1rem; }
        .demo-tag { display: inline-block; background: rgba(0, 255, 0, 0.2); color: #0f0; padding: 0.25rem 0.75rem; border-radius: 4px; font-size: 0.75rem; margin-right: 0.5rem; }

        .modal { 
    display: none; 
    position: fixed; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%; 
    background: rgba(0, 0, 0, 0.95); 
    z-index: 1000; 
    overflow-y: auto;
    padding: 2rem 0;
}
.modal.active { 
    display: block; 
}
.modal-content { 
    background: #111; 
    border: 2px solid #0f0; 
    border-radius: 8px; 
    max-width: 800px; 
    width: 90%; 
    padding: 2rem; 
    margin: 2rem auto;
    max-height: calc(100vh - 4rem);
    overflow-y: auto;
}
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
        .modal-title { color: #ff6b00; font-size: 2rem; }
        .close-btn { background: none; border: none; color: #0f0; font-size: 2rem; cursor: pointer; transition: color 0.3s; }
        .close-btn:hover { color: #ff6b00; }

        .demo-section { margin: 2rem 0; }
        .demo-section h3 { color: #0f0; margin-bottom: 1rem; }
        .qr-placeholder { background: rgba(0, 255, 0, 0.1); border: 2px dashed #0f0; min-height: 200px; display: flex; align-items: center; justify-content: center; border-radius: 8px; margin: 1rem 0; }

        .btn { background: #0f0; color: #000; border: none; padding: 1rem 2rem; font-size: 1rem; font-weight: bold; border-radius: 4px; cursor: pointer; transition: all 0.3s; font-family: 'Courier New', monospace; }
        .btn:hover { background: #ff6b00; color: #fff; transform: scale(1.05); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .next-steps { background: rgba(0, 255, 0, 0.05); border-left: 4px solid #0f0; padding: 1rem; margin: 1rem 0; }
        .next-steps h4 { color: #ff6b00; margin-bottom: 0.5rem; }
        .next-steps ul { list-style: none; padding-left: 0; }
        .next-steps li { color: #888; padding: 0.25rem 0; }
        .next-steps li:before { content: '‚Üí '; color: #0f0; font-weight: bold; }

        .activity { margin: 3rem 0; padding: 2rem; background: rgba(0, 255, 0, 0.05); border: 1px solid #0f0; border-radius: 8px; }
        .activity h2 { color: #ff6b00; margin-bottom: 1rem; }
        .activity-item { padding: 0.75rem; border-bottom: 1px solid rgba(0, 255, 0, 0.2); color: #888; font-size: 0.9rem; }
        .activity-item:last-child { border-bottom: none; }
        .activity-item span { color: #0f0; }

        footer { text-align: center; padding: 2rem; color: #444; font-size: 0.9rem; }
        footer a { color: #0f0; text-decoration: none; }
        footer a:hover { color: #ff6b00; }

        /* Inputs / textareas / code blocks for PoF UI */
        input, textarea {
            background: #000;
            border: 1px solid #0f0;
            color: #0f0;
            padding: 0.5rem;
            font-family: 'Courier New', monospace;
            border-radius: 4px;
        }
        textarea {
            width: 100%;
            min-height: 120px;
            resize: vertical;
        }
        pre {
            background: #050505;
            border: 1px solid #0f0;
            padding: 0.75rem;
            border-radius: 4px;
            font-size: 0.75rem;
            overflow-x: auto;
            color: #0f0;
        }
        code {
            font-family: 'Courier New', monospace;
        }

        @media (max-width: 768px) {
            h1 { font-size: 2rem; }
            .stats { flex-direction: column; gap: 1rem; }
            .demos { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <canvas id="matrix-bg"></canvas>

    <div class="container">
        <div class="hero">
            <h1>The Bitcoin Identity Layer</h1>
            <p class="tagline">Login. Authenticate. Deploy. All in &lt;10 seconds.</p>

            <div class="stats" id="stats-display">
                <div class="stat">‚ö° <span>4.2s</span> avg auth time</div>
                <div class="stat">üîí <span>0</span> authentications today</div>
                <div class="stat">üåç <span>0</span> countries</div>
            </div>
        </div>

        <div class="demos">
            <div class="demo-card" onclick="openDemo('lightning')">
                <div class="demo-icon">‚ö°</div>
                <h3 class="demo-title">Lightning Login</h3>
                <p class="demo-desc">Authenticate with ANY Lightning wallet in 4 seconds. No email, no password.</p>
                <span class="demo-tag">REAL DEMO</span>
                <span class="demo-tag">12 wallets</span>
            </div>

            <div class="demo-card" onclick="openDemo('pof')">
                <div class="demo-icon">üí∞</div>
                <h3 class="demo-title">Proof of Funds</h3>
                <p class="demo-desc">Prove BTC holdings with a PSBT from your own wallet. No addresses revealed.</p>
                <span class="demo-tag">REAL DEMO</span>
                <span class="demo-tag">PSBT + UTXO</span>
            </div>

            <div class="demo-card" onclick="openDemo('covenant')">
                <div class="demo-icon">üîê</div>
                <h3 class="demo-title">Covenant Vault</h3>
                <p class="demo-desc">Create multi-sig vaults with smart contract rules. Ready for OP_CAT.</p>
                <span class="demo-tag">Demo</span>
            </div>

            <div class="demo-card" onclick="openDemo('nostr')">
                <div class="demo-icon">üåê</div>
                <h3 class="demo-title">Nostr + Lightning</h3>
                <p class="demo-desc">Unified identity across Nostr and Lightning. One login, two protocols.</p>
                <span class="demo-tag">REAL DEMO</span>
            </div>
        </div>

        <div class="activity">
            <h2>üî• Live Activity</h2>
            <div id="activity-feed">
                <div class="activity-item"><span>Loading...</span></div>
            </div>
        </div>

        <footer>
            <p>Built with ‚ù§Ô∏è for Bitcoin ‚Ä¢ <a href="https://github.com/hodlxxi">Open Source</a> ‚Ä¢ <a href="/docs">Docs</a></p>
        </footer>
    </div>

    <div id="demo-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modal-title">Demo</h2>
                <button class="close-btn" onclick="closeDemo()">&times;</button>
            </div>
            <div id="modal-body"></div>
        </div>
    </div>

    <script>
        // Matrix Rain
        const canvas = document.getElementById('matrix-bg');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        const matrix = '01';
        const fontSize = 16;
        const columns = canvas.width / fontSize;
        const drops = Array(Math.floor(columns)).fill(1);

        function drawMatrix() {
            ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#0f0';
            ctx.font = fontSize + 'px monospace';

            drops.forEach((y, i) => {
                const text = matrix[Math.floor(Math.random() * matrix.length)];
                const x = i * fontSize;
                ctx.fillText(text, x, y * fontSize);
                if (y * fontSize > canvas.height && Math.random() > 0.975) drops[i] = 0;
                drops[i]++;
            });
        }
        setInterval(drawMatrix, 35);
        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        });

        // Load real stats
        async function loadRealStats() {
            try {
                const res = await fetch('/api/playground/stats');
                const data = await res.json();
                document.getElementById('stats-display').innerHTML = `
                    <div class="stat">‚ö° <span>${data.avgAuthTime}s</span> avg auth time</div>
                    <div class="stat">üîí <span>${data.authsToday}</span> authentications today</div>
                    <div class="stat">üåç <span>${data.countries}</span> countries</div>
                `;
            } catch (e) {
                console.log('Using demo stats');
            }
        }

        // Load real activity
        async function loadRealActivity() {
            try {
                const res = await fetch('/api/playground/activity');
                const data = await res.json();

                const feed = document.getElementById('activity-feed');
                if (data.activities && data.activities.length > 0) {
                    feed.innerHTML = '';
                    data.activities.forEach(a => {
                        const item = document.createElement('div');
                        item.className = 'activity-item';
                        item.innerHTML = `<span>${a.user}</span> ${a.action} in ${a.location}`;
                        feed.appendChild(item);
                    });
                } else {
                    const cities = ['San Francisco', 'London', 'Tokyo', 'Berlin', 'Singapore'];
                    const actions = ['logged in via Lightning', 'verified funds', 'deployed vault'];
                    feed.innerHTML = '';
                    for (let i = 0; i < 5; i++) {
                        const item = document.createElement('div');
                        item.className = 'activity-item';
                        item.innerHTML = `<span>user_${Math.random().toString(36).substr(2, 4)}</span> ${actions[Math.floor(Math.random()*actions.length)]} in ${cities[Math.floor(Math.random()*cities.length)]}`;
                        feed.appendChild(item);
                    }
                }
            } catch (e) {
                console.log('Using demo activity');
            }
        }

        // Real Lightning Login
        async function realLightningLogin() {
            try {
                const btn = event.target;
                const qrDiv = document.querySelector('.qr-placeholder');

                btn.disabled = true;
                btn.textContent = 'Generating QR...';

                const res = await fetch('/api/playground/lightning/init', { method: 'POST' });
                const data = await res.json();

                if (data.error) {
                    alert('Failed: ' + data.error);
                    btn.disabled = false;
                    btn.textContent = 'Try Lightning Login';
                    return;
                }

                qrDiv.innerHTML = `<img src="${data.qrCodeDataUrl}" style="max-width:100%; border-radius:8px;">`;
                btn.textContent = 'Scan with Lightning Wallet';

                const check = async () => {
                    const r = await fetch(`/api/playground/lightning/check/${data.sessionId}`);
                    const d = await r.json();

                    if (d.authenticated) {
                        qrDiv.innerHTML = `
                            <div style="text-align:center; color:#0f0; padding:2rem;">
                                <div style="font-size:3rem;">‚úÖ</div>
                                <h3>Successfully Authenticated!</h3>
                                <p style="color:#888; margin-top:1rem;">
                                    Pubkey: ${d.pubkey ? d.pubkey.substring(0,16)+'...' : 'verified'}
                                </p>
                            </div>
                        `;
                        btn.disabled = false;
                        btn.textContent = 'Try Again';
                    } else if (!d.expired) {
                        setTimeout(check, 2000);
                    } else {
                        qrDiv.innerHTML = '<p style="color:#ff6b00;">Session expired. Try again.</p>';
                        btn.disabled = false;
                        btn.textContent = 'Try Again';
                    }
                };
                check();

            } catch (e) {
                alert('Failed: ' + e.message);
                event.target.disabled = false;
                event.target.textContent = 'Try Lightning Login';
            }
        }

        // Real Nostr Auth
        async function realNostrAuth() {
            try {
                if (!window.nostr) {
                    alert('Please install Alby or nos2x extension to use Nostr authentication');
                    return;
                }

                const resultDiv = document.getElementById('nostr-result');
                resultDiv.innerHTML = '<p style="color:#888;">Getting permission from your Nostr extension...</p>';

                const pubkey = await window.nostr.getPublicKey();

                resultDiv.innerHTML = '<p style="color:#888;">Authenticating with HODLXXI...</p>';

                const res = await fetch('/api/playground/nostr/auth', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ pubkey })
                });

                const data = await res.json();

                if (data.authenticated) {
                    const nextStepsHtml = data.nextSteps ?
                        '<ul>' + data.nextSteps.map(step => `<li>${step}</li>`).join('') + '</ul>' : '';

                    resultDiv.innerHTML = `
                        <div style="text-align:center; color:#0f0; padding:2rem;">
                            <div style="font-size:3rem;">‚úÖ</div>
                            <h3>Successfully Authenticated!</h3>
                            <p style="color:#888; margin-top:1rem;">
                                Nostr Pubkey:<br>
                                <code style="color:#0f0; word-break:break-all; font-size:0.85rem;">${pubkey}</code>
                            </p>
                            ${data.sessionId ? `<p style="color:#888; margin-top:0.5rem; font-size:0.85rem;">Session ID: ${data.sessionId.substring(0,16)}...</p>` : ''}
                        </div>
                        ${nextStepsHtml ? `
                        <div class="next-steps">
                            <h4>What this demonstrates:</h4>
                            ${nextStepsHtml}
                        </div>
                        ` : ''}
                    `;
                } else {
                    alert('Authentication failed: ' + data.error);
                    resultDiv.innerHTML = '';
                }

            } catch (e) {
                const resultDiv = document.getElementById('nostr-result');
                resultDiv.innerHTML = `<p style="color:#ff6b00;">Error: ${e.message}</p>`;
            }
        }

        // Demo content
        const demos = {
            lightning: {
                title: '‚ö° Lightning Login',
                body: `
                    <div class="demo-section">
                        <h3>Try Real Lightning Authentication</h3>
                        <div class="qr-placeholder">
                            <div style="text-align:center;">
                                <p style="color:#0f0; font-size:1.2rem;">Click button below to generate QR</p>
                                <p style="color:#888; margin-top:0.5rem;">Works with Alby, Zeus, Phoenix, Mutiny, Blue Wallet...</p>
                            </div>
                        </div>
                        <button class="btn" onclick="realLightningLogin()">Generate Login QR</button>

                        <div class="next-steps" style="margin-top:2rem;">
                            <h4>How it works:</h4>
                            <ul>
                                <li>Generate a unique challenge (k1)</li>
                                <li>Create LNURL-auth QR code</li>
                                <li>Your wallet signs the challenge</li>
                                <li>Server verifies signature</li>
                                <li>Instant authentication with your Lightning pubkey</li>
                            </ul>
                        </div>
                    </div>
                `
            },
            pof: {
                title: 'üí∞ Proof of Funds',
                body: `
                    <div class="demo-section">
                        <h3>Live Proof of Funds (PoF)</h3>
                        <p style="color:#888; margin-bottom:1rem;">
                            Prove you control a UTXO on Bitcoin mainnet without revealing the address or broadcasting a transaction.
                        </p>

                        <div class="next-steps">
                            <h4>Step 1 ‚Äì Create a PoF challenge</h4>
                            <p style="color:#888; font-size:0.9rem;">
                                Optionally tag the proof with an ID (pubkey, Nostr npub, or nickname). This will be stored with the attestation.
                            </p>
                            <div style="display:flex; flex-wrap:wrap; gap:0.5rem; margin:0.5rem 0 1rem;">
                                <input id="pof-pubkey-input"
                                       placeholder="Optional ID (pubkey / npub / label)"
                                       style="flex:1; min-width:200px;">
                                <button id="pof-challenge-btn" class="btn" type="button">1. Create PoF Challenge</button>
                            </div>
                            <pre id="pof-challenge-output">Click "1. Create PoF Challenge" to begin.</pre>
                        </div>

                        <div class="next-steps">
                            <h4>Step 2 ‚Äì Build a PSBT in your wallet</h4>
                            <div style="background: rgba(255, 59, 48, 0.1); border: 1px solid #ff3b30; border-radius: 8px; padding: 1rem; margin: 0.5rem 0 1rem 0;">
                                <strong style="color: #ff3b30;">‚ö†Ô∏è CRITICAL:</strong> PSBTs <strong>must be signed</strong> before submission. Unsigned PSBTs will be rejected by the server.
                            </div>
                            <p style="color:#888; margin-bottom:0.5rem; font-size:0.9rem;">
                                Use one of the paths below to create a PSBT that spends a UTXO to an <code>OP_RETURN</code> containing the <code>challenge hex</code> from Step 1.
                            </p>

                            <details >
                                <summary style="cursor:pointer; color:#0f0; margin-bottom:0.5rem;">
                                    Path A: Advanced ‚Äì CLI with full node
                                </summary>
                                <p style="color:#888; font-size:0.85rem; margin:0.5rem 0;">
                                    Requires <code>bitcoin-cli</code>, <code>jq</code>, and <code>xxd</code> on your machine.
                                </p>
                                <pre><code># HODLXXI Proof-of-Funds demo (requires bitcoin-cli + jq + xxd)

                                    BASE="https://hodlxxi.com"
PUBKEY_ID="your-label-or-pubkey-here"
RPC_WALLET="YOUR_WALLET_NAME_HERE"

# Configure your Bitcoin RPC credentials
btc() {
  bitcoin-cli -rpcuser=YOUR_RPC_USER -rpcpassword=YOUR_RPC_PASSWORD \
    -rpcwallet="$RPC_WALLET" "$@"
}

echo "========================================"
echo "  HODLXXI SIGNED Proof-of-Funds Test"
echo "========================================"
echo

# Check balance
BALANCE=$(btc getbalance)
echo "Wallet balance: $BALANCE BTC"
echo

echo "== 1) Request PoF challenge =="
CHJSON=$(curl -sS -X POST "$BASE/api/playground/pof/challenge" \
  -H 'Content-Type: application/json' \
  -d "{\"pubkey\":\"$PUBKEY_ID\"}")

echo "$CHJSON" | jq .

CID=$(echo "$CHJSON" | jq -r .challenge_id)
CHALLENGE=$(echo "$CHJSON" | jq -r .challenge)
CHALLENGE_HEX=$(printf "%s" "$CHALLENGE" | xxd -p -c 9999)

echo
echo "Challenge: $CHALLENGE"
echo

echo "== 2) Get UTXOs =="
ALL_UTXOS=$(btc listunspent 0 9999999)
echo "$ALL_UTXOS" | jq '.[] | {txid,vout,amount}'
echo

INPUTS=$(echo "$ALL_UTXOS" | jq '[.[] | {txid,vout}]')

echo "== 3) Create UNSIGNED PSBT =="
PSBT_UNSIGNED=$(btc createpsbt "$INPUTS" "[{\"data\":\"$CHALLENGE_HEX\"}]")
echo "Created unsigned PSBT"
echo

echo "== 4) ‚≠ê SIGN the PSBT (proving key ownership!) =="
SIGNED_RESULT=$(btc walletprocesspsbt "$PSBT_UNSIGNED")
PSBT_SIGNED=$(echo "$SIGNED_RESULT" | jq -r .psbt)
IS_COMPLETE=$(echo "$SIGNED_RESULT" | jq -r .complete)

if [ "$IS_COMPLETE" != "true" ]; then
  echo "‚ùå PSBT not fully signed - verification will fail"
  exit 1
fi

echo "‚úÖ PSBT signed successfully!"
echo

echo "== 5) Submit SIGNED PSBT to verify endpoint =="
RESULT=$(curl -sS -X POST "$BASE/api/playground/pof/verify" \
  -H 'Content-Type: application/json' \
  -d "$(jq -nc --arg cid "$CID" --arg psbt "$PSBT_SIGNED" \
        '{challenge_id:$cid, psbt:$psbt}')")

echo "$RESULT" | jq .

OK=$(echo "$RESULT" | jq -r .ok)
if [ "$OK" = "true" ]; then
  echo ""
  echo "‚úÖ SUCCESS! Cryptographic signatures verified!"
  echo "üîê You proved ownership without revealing addresses!"
fi
                                    </code></pre>
                            </details>

                            <details>
                                <summary style="cursor:pointer; color:#0f0; margin-top:0.5rem;">
                                    Path B: No node ‚Äì Sparrow Wallet
                                </summary>
                                <ol style="margin:0.5rem 0 0.5rem 1.2rem; color:#888; font-size:0.85rem;">
                                    <li>Download &amp; open Sparrow Wallet (mainnet).</li>
                                    <li>Load/import the wallet that holds the UTXO you want to prove.</li>
                                    <li>Go to <strong>UTXOs</strong>, pick a coin &rarr; <strong>Spend Selected</strong>.</li>
                                    <li>In the <strong>Send</strong> tab, add a new output of type <strong>OP_RETURN / DATA</strong> and paste the <code>challenge hex</code> from Step 1.</li>
                                    <li>Set the amount for the OP_RETURN output to <strong>0 sats</strong> (data only). Sparrow will create change back to your wallet.</li>
                                    <li>Instead of broadcasting, choose <strong>Finalize &rarr; Sign</strong> (sign the transaction with your wallet), then <strong>Export PSBT (Base64)</strong>.</li>
                                    <li>Copy that PSBT (base64) and paste it into the box in Step 3 below.</li>
                                </ol>
                            </details>

                            <p style="color:#666; font-size:0.8rem; margin-top:0.75rem;">
                                Power users can also use Specter, Bitcoin Core GUI, Nunchuk, or any wallet that can create a PSBT
                                with a chosen UTXO and an <code>OP_RETURN</code> containing the challenge hex.
                            </p>
                        </div>

                        <div class="next-steps">
                            <h4>Step 3 ‚Äì Paste PSBT &amp; verify</h4>
                            <textarea id="pof-psbt-input"
                                      placeholder="Paste PSBT base64 from your wallet here"></textarea>
                            <button id="pof-verify-btn" class="btn" type="button" style="margin-top:0.75rem;">
                                2. Verify Proof Now
                            </button>
                            <div id="pof-result" style="margin-top:1rem; font-size:0.9rem;"></div>
                        </div>

                        <div class="next-steps">
                            <h4>For devs: copy-paste script</h4>
                            <p style="color:#888; font-size:0.85rem;">
                                This is the exact <code>curl</code> + <code>bitcoin-cli</code> flow used in the demo. You can adapt it for your own backend tests or CI.
                            </p>
                            <details>
                                <summary style="cursor:pointer; color:#0f0;">Show dev script</summary>
                                <pre><code># Same PoF flow as above, consolidated:

                                    BASE="https://hodlxxi.com"
PUBKEY_ID="your-label"
RPC_WALLET="YOUR_WALLET"

# 1) Get challenge
CHJSON=$(curl -sS -X POST "$BASE/api/playground/pof/challenge" \
  -H 'Content-Type: application/json' \
  -d "{\"pubkey\":\"$PUBKEY_ID\"}")

CID=$(echo "$CHJSON" | jq -r .challenge_id)
CHALLENGE=$(echo "$CHJSON" | jq -r .challenge)
CHALLENGE_HEX=$(printf "%s" "$CHALLENGE" | xxd -p -c 9999)

# 2) Get UTXOs and create inputs
INPUTS=$(bitcoin-cli -rpcwallet="$RPC_WALLET" listunspent 0 9999999 | jq '[.[] | {txid,vout}]')

# 3) Create UNSIGNED PSBT
PSBT_UNSIGNED=$(bitcoin-cli -rpcwallet="$RPC_WALLET" \
  createpsbt "$INPUTS" "[{\"data\":\"$CHALLENGE_HEX\"}]")

# 4) ‚≠ê SIGN the PSBT (critical step!)
SIGNED=$(bitcoin-cli -rpcwallet="$RPC_WALLET" walletprocesspsbt "$PSBT_UNSIGNED")
PSBT_SIGNED=$(echo "$SIGNED" | jq -r .psbt)

# 5) Verify with signed PSBT
curl -sS -X POST "$BASE/api/playground/pof/verify" \
  -H 'Content-Type: application/json' \
  -d "$(jq -nc --arg cid "$CID" --arg psbt "$PSBT_SIGNED" \
        '{challenge_id:$cid, psbt:$psbt}')" | jq .</code></pre>
                            </details>
                        </div>
                    </div>
                `
            },
            covenant: {
                title: 'üîê Covenant Vault',
                body: `
                    <div class="demo-section">
                        <h3>Demo Preview</h3>
                        <p style="color:#888;">
                            Multi-signature vault creation with covenant templates.
                            Full implementation coming soon!
                        </p>
                        <div class="next-steps" style="margin-top:2rem;">
                            <h4>Features:</h4>
                            <ul>
                                <li>Multi-sig with timelock constraints</li>
                                <li>Spending rules enforced on-chain</li>
                                <li>Compatible with future OP_CAT activation</li>
                                <li>Inheritance and recovery options</li>
                            </ul>
                        </div>
                    </div>
                `
            },
            nostr: {
                title: 'üåê Nostr + Lightning',
                body: `
                    <div class="demo-section">
                        <h3>Authenticate with Nostr</h3>
                        <p style="color:#888; margin-bottom:1rem;">
                            Requires Alby, nos2x, or another NIP-07 browser extension
                        </p>
                        <div id="nostr-result"></div>
                        <button class="btn" onclick="realNostrAuth()">Connect with Nostr</button>

                        <div class="next-steps" style="margin-top:2rem;">
                            <h4>Why Nostr + Bitcoin?</h4>
                            <ul>
                                <li>Same cryptographic keys for both protocols</li>
                                <li>Link your Nostr social graph to Bitcoin identity</li>
                                <li>Enable zaps and payments in one flow</li>
                                <li>Decentralized reputation system</li>
                            </ul>
                        </div>
                    </div>
                `
            }
        };

        let POF_CURRENT_CHALLENGE = null;

        function initPofModal() {
            const pubInput = document.getElementById('pof-pubkey-input');
            const challengeBtn = document.getElementById('pof-challenge-btn');
            const challengePre = document.getElementById('pof-challenge-output');
            const psbtInput = document.getElementById('pof-psbt-input');
            const verifyBtn = document.getElementById('pof-verify-btn');
            const resultDiv = document.getElementById('pof-result');

            if (!challengeBtn || !challengePre) return;

            POF_CURRENT_CHALLENGE = null;
            challengePre.textContent = 'Click "1. Create PoF Challenge" to begin.';
            if (resultDiv) resultDiv.textContent = '';

            function textToHex(str) {
                let hex = '';
                for (let i = 0; i < str.length; i++) {
                    hex += str.charCodeAt(i).toString(16).padStart(2, '0');
                }
                return hex;
            }

            challengeBtn.onclick = async () => {
                try {
                    challengeBtn.disabled = true;
                    challengeBtn.textContent = 'Creating challenge...';
                    if (resultDiv) resultDiv.innerHTML = '';

                    const pubkeyId = (pubInput && pubInput.value.trim()) || 'playground-demo';

                    const res = await fetch('/api/playground/pof/challenge', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ pubkey: pubkeyId })
                    });
                    const data = await res.json();
                    if (!data.ok) {
                        alert('Failed to create challenge: ' + (data.error || 'Unknown error'));
                        return;
                    }

                    const hex = textToHex(data.challenge);
                    POF_CURRENT_CHALLENGE = {
                        id: data.challenge_id,
                        text: data.challenge,
                        hex,
                        expiresIn: data.expires_in
                    };

                    challengePre.textContent =
`challenge_id:   ${data.challenge_id}
challenge text: ${data.challenge}
challenge hex:  ${hex}
expires in:     ${data.expires_in}s`;

                } catch (err) {
                    console.error(err);
                    alert('Error creating challenge: ' + err.message);
                } finally {
                    challengeBtn.disabled = false;
                    challengeBtn.textContent = '1. Create PoF Challenge';
                }
            };

            if (verifyBtn && psbtInput && resultDiv) {
                verifyBtn.onclick = async () => {
                    try {
                        if (!POF_CURRENT_CHALLENGE) {
                            alert('Create a challenge first in Step 1.');
                            return;
                        }
                        const psbt = psbtInput.value.trim();
                        if (!psbt) {
                            alert('Paste a PSBT (base64) from your wallet first.');
                            return;
                        }
                        verifyBtn.disabled = true;
                        verifyBtn.textContent = 'Verifying...';
                        resultDiv.innerHTML = '<p style="color:#888;">Verifying proof on HODLXXI...</p>';

                        const res = await fetch('/api/playground/pof/verify', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                challenge_id: POF_CURRENT_CHALLENGE.id,
                                psbt
                            })
                        });
                        const data = await res.json();

                        if (data.ok) {
                            const btc = (typeof data.total_btc === 'number')
                                ? data.total_btc
                                : (data.total_sat ? (data.total_sat / 1e8) : null);

                            resultDiv.innerHTML = `
                                <div style="color:#0f0;">
                                    <div style="font-size:2rem;">‚úÖ PoF verified</div>
                                    <p style="margin-top:0.5rem;">
                                        Total proven:
                                        <strong>${btc !== null ? btc.toFixed(8) + ' BTC' : (data.total_sat + ' sats')}</strong>
                                    </p>
                                    <p style="color:#888; margin-top:0.25rem;">
                                        Unspent inputs counted: ${data.unspent_count}
                                    </p>
                                    <p style="color:#555; margin-top:0.25rem; font-size:0.8rem;">
                                        proof_id: ${data.proof_id || 'n/a'}
                                    </p>
                                </div>
                            `;
                        } else {
                            resultDiv.innerHTML = `<p style="color:#ff6b00;">Error: ${data.error || 'Verification failed'}</p>`;
                        }
                    } catch (err) {
                        console.error(err);
                        resultDiv.innerHTML = `<p style="color:#ff6b00;">Error: ${err.message}</p>`;
                    } finally {
                        verifyBtn.disabled = false;
                        verifyBtn.textContent = '2. Verify Proof Now';
                    }
                };
            }
        }

        function openDemo(type) {
            const demo = demos[type];
            const body = document.getElementById('modal-body');
            document.getElementById('modal-title').textContent = demo.title;
            body.innerHTML = demo.body;
            document.getElementById('demo-modal').classList.add('active');

            if (type === 'pof') {
                initPofModal();
            }
        }

        function closeDemo() {
            document.getElementById('demo-modal').classList.remove('active');
        }

        document.getElementById('demo-modal').addEventListener('click', (e) => {
            if (e.target.id === 'demo-modal') closeDemo();
        });

        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            loadRealStats();
            loadRealActivity();
            setInterval(() => {
                loadRealStats();
                loadRealActivity();
            }, 10000);
        });
    </script>
</body>
</html>
	
